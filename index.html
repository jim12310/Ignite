// Fixed webhook URLs - These are your current URLs from the code
const APPLICATION_WEBHOOK = 'https://discord.com/api/webhooks/1312519842829549754/ZZyDaJR4Pp39mm4AVnwmz6oSTTM8VC3leiF54mNGnXbOQTZDRe_7d0nvo9P4AzKxCNaY';
const ADMIN_WEBHOOK = 'https://discord.com/api/webhooks/1312519842829549264/wokEy-9DqZ6LqqWXGBsmoVVwvK7EypaoJzmbFIZ5c-rOtSPq2oEUdmmUYPW9ddw-0Imz';

// Improved application form handler
function setupApplicationForm() {
    const form = document.getElementById('applicationForm');
    if (!form) {
        console.error('❌ Application form not found!');
        return;
    }
    
    console.log('✅ Application form found, setting up handler...');
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('🔥 Form submitted - starting processing...');
        
        const submitButton = this.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;
        submitButton.textContent = 'Submitting...';
        submitButton.disabled = true;
        
        try {
            // Collect form data by input names/IDs rather than placeholders
            const inputs = this.querySelectorAll('input, select, textarea');
            const data = {};
            
            inputs.forEach((input, index) => {
                const value = input.value ? input.value.trim() : '';
                const placeholder = input.placeholder || '';
                
                // Map inputs by their position and placeholder for better reliability
                if (placeholder.includes('in-game name') || placeholder === 'Your in-game name') {
                    data.rsn = value;
                } else if (placeholder === '1750+') {
                    data.totalLevel = value;
                } else if (placeholder === '115+') {
                    data.combatLevel = value;
                } else if (placeholder === '200+') {
                    data.questPoints = value;
                } else if (placeholder === '94+') {
                    data.magicLevel = value;
                } else if (placeholder === '90+') {
                    data.rangedLevel = value;
                } else if (placeholder === '83+') {
                    data.constructionLevel = value;
                } else if (placeholder === '78+') {
                    data.herbloreLevel = value;
                } else if (placeholder.includes('username#1234') || placeholder.includes('Discord')) {
                    data.discordUsername = value;
                } else if (placeholder.includes('Tell us about yourself')) {
                    data.whyJoin = value;
                }
            });
            
            // Get KC values from the specific KC inputs
            const kcInputs = this.querySelectorAll('input[placeholder="Enter KC"]');
            const coxKc = kcInputs[0]?.value || '0';
            const tobKc = kcInputs[1]?.value || '0';
            const toaKc = kcInputs[2]?.value || '0';
            const totalRaidKc = parseInt(coxKc) + parseInt(tobKc) + parseInt(toaKc);
            
            // Get select values
            const selects = this.querySelectorAll('select');
            const fireCape = selects[0]?.value || 'Not specified';
            const augury = selects[1]?.value || 'Not specified';
            const piety = selects[2]?.value || 'Not specified';
            const rigour = selects[3]?.value || 'Not specified';
            const howHeard = selects[4]?.value || 'Not specified';
            
            console.log('📋 Collected form data:', {
                rsn: data.rsn,
                discord: data.discordUsername,
                totalLevel: data.totalLevel,
                combatLevel: data.combatLevel,
                totalRaidKc: totalRaidKc
            });
            
            // Validate required fields
            if (!data.rsn) {
                throw new Error('Please enter your RSN (RuneScape Name)');
            }
            if (!data.discordUsername) {
                throw new Error('Please enter your Discord username');
            }
            if (!data.totalLevel) {
                throw new Error('Please enter your total level');
            }
            if (!data.combatLevel) {
                throw new Error('Please enter your combat level');
            }
            
            // Create Discord embed with proper error handling
            const embed = {
                title: "🔥 New Clan Application",
                color: 16744448, // Orange color in decimal
                description: `New application from **${data.rsn}**`,
                fields: [
                    { name: "👤 RSN", value: data.rsn, inline: true },
                    { name: "💬 Discord", value: data.discordUsername, inline: true },
                    { name: "📊 Total Level", value: data.totalLevel || "Not provided", inline: true },
                    { name: "⚔️ Combat Level", value: data.combatLevel || "Not provided", inline: true },
                    { name: "📜 Quest Points", value: data.questPoints || "Not provided", inline: true },
                    { name: "🔮 Magic Level", value: data.magicLevel || "Not provided", inline: true },
                    { name: "🏹 Ranged Level", value: data.rangedLevel || "Not provided", inline: true },
                    { name: "🏠 Construction", value: data.constructionLevel || "Not provided", inline: true },
                    { name: "🧪 Herblore", value: data.herbloreLevel || "Not provided", inline: true },
                    { name: "🔥 Fire Cape", value: fireCape, inline: true },
                    { name: "🏛️ Chambers KC", value: coxKc, inline: true },
                    { name: "🎭 Theatre KC", value: tobKc, inline: true },
                    { name: "🏺 Tombs KC", value: toaKc, inline: true },
                    { name: "🎯 Total Raid KC", value: totalRaidKc.toString(), inline: true },
                    { name: "📿 Augury", value: augury, inline: true },
                    { name: "⚔️ Piety", value: piety, inline: true },
                    { name: "🏹 Rigour", value: rigour, inline: true }
                ],
                timestamp: new Date().toISOString(),
                footer: {
                    text: "Ignite Clan Application System"
                }
            };
            
            // Add optional longer fields
            if (data.whyJoin && data.whyJoin.trim()) {
                embed.fields.push({
                    name: "💭 Why join Ignite?",
                    value: data.whyJoin.substring(0, 1024), // Discord field limit
                    inline: false
                });
            }
            
            if (howHeard && howHeard !== 'Select an option') {
                embed.fields.push({
                    name: "📢 How did you hear about us?",
                    value: howHeard,
                    inline: false
                });
            }
            
            const payload = {
                content: "🔥 **New Clan Application Received!**",
                embeds: [embed]
            };
            
            console.log('📡 Sending to Discord webhook...');
            console.log('🔗 Webhook URL (first 50 chars):', APPLICATION_WEBHOOK.substring(0, 50) + '...');
            
            // Send to Discord with detailed error handling
            const response = await fetch(APPLICATION_WEBHOOK, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });
            
            console.log('📊 Discord response status:', response.status);
            console.log('📊 Discord response headers:', [...response.headers.entries()]);
            
            // Get response text for debugging
            const responseText = await response.text();
            console.log('📄 Discord response body:', responseText);
            
            if (!response.ok) {
                console.error('❌ Discord webhook error:', {
                    status: response.status,
                    statusText: response.statusText,
                    body: responseText
                });
                
                let errorMessage = `Discord webhook failed: ${response.status} ${response.statusText}`;
                
                if (response.status === 404) {
                    errorMessage = 'Webhook not found (404). The webhook URL may be incorrect or the webhook was deleted from Discord.';
                } else if (response.status === 401 || response.status === 403) {
                    errorMessage = 'Webhook authentication failed. Please check the webhook URL is correct.';
                } else if (response.status === 429) {
                    errorMessage = 'Rate limited. Please wait a moment and try again.';
                }
                
                throw new Error(errorMessage + '\n\nResponse: ' + responseText);
            }
            
            console.log('✅ Application sent successfully to Discord!');
            
            // Show success message
            alert('🎉 Application submitted successfully!\n\nYour application has been sent to our Discord server. You should receive a response within 24-48 hours.');
            
            // Show thank you page
            showThankYouPage(data.rsn);
            
        } catch (error) {
            console.error('💥 Error submitting application:', error);
            
            // Log error details for debugging
            if (error.name) console.error('Error name:', error.name);
            if (error.stack) console.error('Error stack:', error.stack);
            
            let userErrorMessage = 'There was an error submitting your application:\n\n';
            
            if (error.message.includes('404') || error.message.includes('Unknown Webhook')) {
                userErrorMessage += '❌ Webhook configuration error.\n\n';
                userErrorMessage += 'The Discord webhook may not be set up correctly. ';
                userErrorMessage += 'Please contact the clan leadership directly on Discord:\n';
                userErrorMessage += 'https://discord.gg/mK8pUe3F5t';
            } else if (error.message.includes('Failed to fetch') || error.message.includes('network')) {
                userErrorMessage += '🌐 Network connection issue.\n\n';
                userErrorMessage += 'Please check your internet connection and try again. ';
                userErrorMessage += 'If the problem persists, try refreshing the page.';
            } else if (error.message.includes('Please enter')) {
                userErrorMessage += '📝 Form validation error:\n\n' + error.message;
            } else {
                userErrorMessage += error.message + '\n\n';
                userErrorMessage += 'If this problem continues, please contact us directly on Discord:\n';
                userErrorMessage += 'https://discord.gg/mK8pUe3F5t';
            }
            
            alert(userErrorMessage);
            
        } finally {
            submitButton.textContent = originalText;
            submitButton.disabled = false;
        }
    });
}

// Test webhook function for debugging
async function testWebhookConnection() {
    console.log('🧪 Testing webhook connection...');
    
    try {
        const testPayload = {
            content: "🧪 **Webhook Test**",
            embeds: [{
                title: "Connection Test",
                description: "This is a test message to verify the webhook is working correctly.",
                color: 16744448,
                timestamp: new Date().toISOString(),
                footer: {
                    text: "Test from Ignite website"
                }
            }]
        };

        const response = await fetch(APPLICATION_WEBHOOK, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(testPayload)
        });

        console.log('🧪 Test response status:', response.status);
        const responseText = await response.text();
        console.log('🧪 Test response body:', responseText);

        if (response.ok) {
            console.log('✅ Webhook test PASSED! Check your Discord channel.');
            return true;
        } else {
            console.error('❌ Webhook test FAILED:', response.status, responseText);
            return false;
        }
    } catch (error) {
        console.error('❌ Webhook test ERROR:', error);
        return false;
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔥 Initializing Ignite application system...');
    setupApplicationForm();
    
    // Optional: Test webhook on page load (remove this in production)
    // testWebhookConnection();
});
